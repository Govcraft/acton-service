use acton_service::prelude::*;
use anyhow::Result;

{% if http -%}
mod handlers;
{% endif -%}
{%- if grpc %}
// Note: When you add gRPC services, create src/services.rs and add: mod services;
{% endif %}

#[tokio::main]
async fn main() -> Result<()> {
{%- if http and not grpc %}
    // Build versioned routes
    let routes = VersionedApiBuilder::new()
        .with_base_path("/api")
        .add_version(ApiVersion::V1, |router| {
            // TODO: Add your routes here
            // Example: router.route("/users", get(handlers::list_users))
            router
        })
        .build_routes();

    // Build and serve
    ServiceBuilder::new()
        .with_routes(routes)
        .build()
        .serve()
        .await?;

    Ok(())
{%- elif grpc and not http %}
    // TODO: Configure your gRPC services

    // Build and serve gRPC
    let addr = "0.0.0.0:9090".parse().unwrap();

    println!("gRPC server listening on {}", addr);

    // TODO: Add gRPC service implementation
    // let service = YourServiceImpl::default();
    // Server::builder()
    //     .add_service(YourServiceServer::new(service))
    //     .serve(addr)
    //     .await?;

    Ok(())
{%- elif http and grpc %}
    // Build HTTP routes
    let http_routes = VersionedApiBuilder::new()
        .with_base_path("/api")
        .add_version(ApiVersion::V1, |router| {
            // TODO: Add your HTTP routes here
            // Example: router.route("/users", get(handlers::list_users))
            router
        })
        .build_routes();

    // Build gRPC services
    // TODO: Add your gRPC service implementations
    // Example:
    // let grpc_routes = tonic::service::RoutesBuilder::default()
    //     .add_service(YourServiceServer::new(YourServiceImpl::default()))
    //     .routes();

    // Single-port HTTP + gRPC (automatic protocol detection)
    // Both protocols served on the same port (default: 8080)
    // Set use_separate_port = true in config.toml to use separate ports
    ServiceBuilder::new()
        .with_routes(http_routes)
        // .with_grpc_services(grpc_routes)  // Uncomment when you add gRPC services
        .build()
        .serve()
        .await?;

    Ok(())
{%- endif %}
}
