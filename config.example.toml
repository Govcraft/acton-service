# Example configuration file for acton-service microservices
# Copy this to config.toml and customize for your service

[service]
name = "my-service"
port = 8080
log_level = "info"  # trace, debug, info, warn, error
timeout_secs = 30
environment = "dev"  # dev, staging, production

[jwt]
public_key_path = "./keys/jwt-public.pem"
algorithm = "RS256"  # RS256, ES256, HS256
issuer = "https://auth.mydomain.com"
audience = "api.mydomain.com"

[rate_limit]
# Redis-based global rate limiting
per_user_rpm = 200      # Requests per minute per user
per_client_rpm = 1000   # Requests per minute per API client
window_secs = 60

# ============================================================================
# MIDDLEWARE CONFIGURATION
# ============================================================================

[middleware]
# Request body size limit (in MB)
body_limit_mb = 10

# Enable panic recovery (convert panics to 500 responses)
catch_panic = true

# Enable response compression (gzip, br, deflate, zstd)
compression = true

# CORS mode: "permissive", "restrictive", or "disabled"
cors_mode = "permissive"

# ----------------------------------------------------------------------------
# Request Tracking (Request IDs, Header Propagation, Distributed Tracing)
# ----------------------------------------------------------------------------
[middleware.request_tracking]
# Generate and propagate request IDs for distributed tracing
request_id_enabled = true
request_id_header = "x-request-id"

# Propagate headers between microservices (x-request-id, x-trace-id, etc.)
propagate_headers = true

# Mask sensitive headers in logs (authorization, cookie, x-api-key, etc.)
mask_sensitive_headers = true

# ----------------------------------------------------------------------------
# Resilience (Circuit Breaker, Retry, Bulkhead)
# Requires feature: resilience
# ----------------------------------------------------------------------------
[middleware.resilience]
# Circuit breaker configuration
circuit_breaker_enabled = true
circuit_breaker_threshold = 0.5      # 50% failure rate opens circuit
circuit_breaker_min_requests = 10    # Minimum requests before calculating
circuit_breaker_wait_secs = 30       # Wait before attempting to close

# Retry configuration
retry_enabled = true
retry_max_attempts = 3
retry_base_delay_ms = 100           # Initial delay (exponential backoff)
retry_max_delay_ms = 10000          # Maximum delay (10 seconds)

# Bulkhead configuration (concurrency limiting)
bulkhead_enabled = true
bulkhead_max_concurrent = 100       # Max concurrent requests
bulkhead_max_queued = 200           # Max queued requests

# ----------------------------------------------------------------------------
# HTTP Metrics (OpenTelemetry)
# Requires feature: otel-metrics
# ----------------------------------------------------------------------------
[middleware.metrics]
enabled = true

# Include dimensions in metrics
include_path = true
include_method = true
include_status = true

# Latency histogram buckets (in milliseconds)
latency_buckets_ms = [5.0, 10.0, 25.0, 50.0, 100.0, 250.0, 500.0, 1000.0, 2500.0, 5000.0, 10000.0]

# ----------------------------------------------------------------------------
# Local Rate Limiting (Governor)
# Requires feature: governor
# In-memory rate limiting as fallback when Redis is unavailable
# ----------------------------------------------------------------------------
[middleware.governor]
enabled = true
requests_per_period = 100    # Max requests per period
period_secs = 60             # Time period in seconds (60 = per minute)
burst_size = 10              # Allow temporary bursts

# ----------------------------------------------------------------------------
# Security Headers
# No feature gate required -- uses existing tower-http set-header
# ----------------------------------------------------------------------------
[middleware.security_headers]
enabled = true
hsts = true                              # Strict-Transport-Security (only sent when TLS active)
hsts_max_age_secs = 63072000             # 2 years (OWASP recommendation)
hsts_include_subdomains = false
hsts_preload = false
x_content_type_options = true            # X-Content-Type-Options: nosniff
x_frame_options = "DENY"                 # X-Frame-Options value
x_xss_protection = true                  # X-XSS-Protection: 0 (modern rec: disable browser filter)
referrer_policy = "strict-origin-when-cross-origin"
# permissions_policy = "camera=(), microphone=(), geolocation=()"  # Optional

# ============================================================================
# TLS CONFIGURATION (Optional)
# Requires feature: tls
# ============================================================================
# [tls]
# enabled = true
# cert_path = "./certs/server.pem"       # PEM-encoded certificate chain
# key_path = "./certs/server-key.pem"    # PEM-encoded private key

# ============================================================================
# DATABASE CONFIGURATION (Optional)
# ============================================================================
[database]
url = "postgres://user:password@ysql.ysql-cluster.svc.cluster.local:5433/users_db"
max_connections = 50
min_connections = 5
connection_timeout_secs = 10
max_retries = 5
retry_delay_secs = 2
optional = false      # Service can start without DB if true
lazy_init = true      # Initialize connection in background

# ============================================================================
# SURREALDB CONFIGURATION (Optional)
# Mutually exclusive with [database] and [turso]
# ============================================================================
# [surrealdb]
# url = "ws://localhost:8000"   # ws://, wss://, http://, https://, or mem://
# namespace = "default"
# database = "default"
# username = "root"             # Optional: omit for unauthenticated access
# password = "root"             # Optional: omit for unauthenticated access
# max_retries = 5
# retry_delay_secs = 2
# optional = false              # Service can start without SurrealDB if true
# lazy_init = true              # Initialize connection in background

# ============================================================================
# REDIS CONFIGURATION (Optional)
# ============================================================================
[redis]
url = "redis://redis.redis-cluster.svc.cluster.local:6379"
max_connections = 20
connection_timeout_secs = 10
max_retries = 5
retry_delay_secs = 2
optional = false      # Service can start without Redis if true
lazy_init = true      # Initialize connection in background

# ============================================================================
# NATS CONFIGURATION (Optional)
# ============================================================================
[nats]
url = "nats://nats.nats-cluster.svc.cluster.local:4222"
name = "my-service"
max_reconnects = 10
max_retries = 5
retry_delay_secs = 2
optional = false      # Service can start without NATS if true
lazy_init = true      # Initialize connection in background

# ============================================================================
# AUDIT LOGGING CONFIGURATION (Optional)
# Requires feature: audit
# ============================================================================
# [audit]
# enabled = true
# audit_all_requests = false        # Audit every HTTP request (noisy)
# audit_auth_events = true          # Auto-audit auth events (login, logout, etc.)
# otlp_logs_enabled = false         # Export audit logs via OTLP (requires observability)
# audited_routes = ["/api/v1/admin/*"]   # Glob patterns for per-route auditing
# excluded_routes = ["/health", "/ready", "/metrics"]
#
# retention_days = 90               # Days to keep events (omit for infinite)
# archive_path = "/var/audit/archive"  # JSONL archive dir before purge (omit to skip)
# cleanup_interval_hours = 24       # Hours between cleanup runs
#
# [audit.syslog]
# transport = "udp"                 # "udp", "tcp", or "none"
# address = "127.0.0.1:514"
# facility = 13                     # 13 = audit (RFC 5424)
# # app_name = "my-service"         # Defaults to service.name
#
# [audit.alerts]
# enabled = true
# threshold_secs = 30
# cooldown_secs = 300
# notify_recovery = true
#
# [[audit.alerts.webhooks]]
# url = "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
# timeout_secs = 10
# # headers = { "Authorization" = "Bearer your-token" }

# ============================================================================
# LOGIN LOCKOUT CONFIGURATION (Optional)
# Requires feature: login-lockout (depends on auth + cache)
# ============================================================================
# [lockout]
# enabled = true
# max_attempts = 5                  # Lock after 5 failures
# window_secs = 900                 # 15-minute rolling window
# lockout_duration_secs = 1800      # Lock for 30 minutes
# progressive_delay_enabled = true  # Apply exponential backoff delays
# base_delay_ms = 1000              # 1 second initial delay
# max_delay_ms = 30000              # 30 second max delay
# delay_multiplier = 2.0            # Double delay each attempt
# warning_threshold = 3             # Notify after 3 failures (0 = disabled)
# key_prefix = "lockout"            # Redis key prefix

# ============================================================================
# OPENTELEMETRY CONFIGURATION (Optional)
# ============================================================================
[otlp]
endpoint = "http://otel-collector:4317"
service_name = "my-service"
enabled = true
